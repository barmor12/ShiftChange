<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<title>× ×™×”×•×œ ××©×ª××©×™×</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Segoe UI,Arial; background:#f4f6fb; margin:0; color:#0f172a;}
header{background:#fff; padding:18px 22px; border-bottom:1px solid #e5e7eb; display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
a{padding:10px 14px; border-radius:10px; text-decoration:none; color:#fff; background:#2563eb;}
a.gray{background:#6b7280;}
main{max-width:1100px; margin:20px auto; padding:0 16px;}
.card{background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:16px; margin-bottom:14px;}
input,select{padding:10px; border:1px solid #e5e7eb; border-radius:10px; width:100%; font-size:14px;}
button{padding:10px 14px; border:none; border-radius:10px; cursor:pointer; background:#16a34a; color:#fff;}
table{width:100%; border-collapse:collapse;}
th,td{padding:10px; border-bottom:1px solid #e5e7eb; text-align:right;}
th{background:#f8fafc; color:#64748b;}
.row{display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:10px; align-items:end;}
.err{color:#b91c1c; margin:8px 0 0;}
.badge{display:inline-flex; gap:6px; align-items:center; font-size:12px; padding:6px 10px; border:1px solid #e5e7eb; border-radius:999px; background:#fff; color:#64748b;}
.badge strong{color:#0f172a;}
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:50;
}
.modal.hidden{display:none;}
.modal-box{
  background:#fff;
  padding:20px;
  border-radius:14px;
  width:360px;
  display:grid;
  gap:10px;
}
</style>
</head>
<body>

<header>
  <a class="gray" href="/">â¬… ×—×–×¨×”</a>
  <a class="gray" href="/audit">ğŸ“œ Audit</a>
  <a class="gray" href="/logout">ğŸšª ×”×ª× ×ª×§×•×ª</a>

  {% if state and state.last_modified_by %}
    <span class="badge">
      ×¢×•×“×›×Ÿ ×œ××—×¨×•× ×” ×¢"×™ <strong>{{ state.last_modified_by }}</strong> | {{ state.last_modified_at }}
    </span>
  {% endif %}
</header>

<main>
  <div class="card">
    <h2 style="margin:0 0 12px;">×™×¦×™×¨×ª ××©×ª××© ×—×“×©</h2>

    <form method="POST" action="/users/create" class="row">
      <div>
        <label>×©× ××©×ª××©</label>
        <input name="username" placeholder="×œ×“×•×’××”: mor" required>
      </div>
      <div>
        <label>×¡×™×¡××”</label>
        <input
          name="password"
          type="password"
          minlength="6"
          placeholder="×œ×¤×—×•×ª 6 ×ª×•×•×™×"
          required
        >
      </div>
      <div>
        <label>×ª×¤×§×™×“</label>
        <select name="role">
          <option value="user">user</option>
          <option value="admin">admin</option>
        </select>
      </div>
      <div>
        <button type="submit">â• ×”×•×¡×£</button>
      </div>
    </form>

    {% if error %}
      <div class="err">{{ error }}</div>
    {% endif %}
  </div>

  <div class="card">
    <h2 style="margin:0 0 12px;">×¨×©×™××ª ××©×ª××©×™×</h2>

    <table>
      <thead>
        <tr>
          <th style="width:260px;">×©× ××©×ª××©</th>
          <th style="width:180px;">×ª×¤×§×™×“</th>
          <th>×”×¢×¨×”</th>
        </tr>
      </thead>
      <tbody>
        {% for uname, udata in users.items() %}
        <tr>
          <td><strong>{{ uname }}</strong></td>
          <td>{{ udata.role }}</td>
          <td>
            <button onclick="openEdit('{{ uname }}','{{ udata.role }}')">âœï¸</button>
            <button onclick="deleteUser('{{ uname }}')" style="background:#dc2626">âŒ</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</main>

<div id="editModal" class="modal hidden">
  <div class="modal-box">
    <h3>×¢×¨×™×›×ª ××©×ª××©</h3>

    <label>×©× ××©×ª××©</label>
    <input id="editUser" disabled>

    <label>×¡×™×¡××” ×—×“×©×”</label>
    <input id="editPass" placeholder="×”×©××¨ ×¨×™×§ ×× ×œ× ×œ×©× ×•×ª">

    <label>×ª×¤×§×™×“</label>
    <select id="editRole">
      <option value="user">user</option>
      <option value="admin">admin</option>
    </select>

    <div style="display:flex; gap:8px; justify-content:flex-end;">
      <button onclick="closeEdit()" style="background:#6b7280">×‘×™×˜×•×œ</button>
      <button onclick="saveEdit()">ğŸ’¾ ×©××•×¨</button>
    </div>
  </div>
</div>
</body>
</html>

<script>
let currentUser = null;

function openEdit(user, role){
  currentUser = user;
  document.getElementById("editUser").value = user;
  document.getElementById("editRole").value = role;
  document.getElementById("editModal").style.display = "block";
}

async function saveEdit(){
  const password = document.getElementById("editPass").value;
  const role = document.getElementById("editRole").value;

  const res = await fetch("/users/update",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ username:currentUser, password, role })
  });

  const data = await res.json();
  if(!res.ok) alert(data.error);
  else window.location.href = "/users";
}
async function deleteUser(username){
  if(username === "{{ user }}"){
    alert("×œ× × ×™×ª×Ÿ ×œ××—×•×§ ××ª ×”××©×ª××© ×©××—×•×‘×¨ ×›×¢×ª");
    return;
  }

  const warning = confirm(
    "âš ï¸ ××—×™×§×ª ××©×ª××© ×”×™× ×¤×¢×•×œ×” ×‘×œ×ª×™ ×”×¤×™×›×”.\n\n×”×× ××ª×” ×‘×˜×•×—?"
  );
  if(!warning) return;

const password = prompt(
  "×œ××™×©×•×¨ ×”××—×™×§×” â€“ ×”×–×Ÿ ××ª ×”×¡×™×¡××” ×©×œ ×”××©×ª××©:\n" + username
);
  if(!password) return;

  const res = await fetch("/users/delete",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ username, password })
  });

  const data = await res.json();
  if(!res.ok){
    alert(data.error);
  } else {
    window.location.href = "/users";
  }
}
</script>