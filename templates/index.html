<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<title>××¢×¨×›×ª ×”×©×œ××ª ×©×¢×•×ª</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg:#f4f6fb;
  --card:#ffffff;
  --primary:#2563eb;
  --primary-dark:#1e40af;
  --border:#e5e7eb;
  --text:#0f172a;
  --muted:#64748b;
  --accent:#fbbf24;
  --ok:#16a34a;
  --danger:#dc2626;
  --gray:#6b7280;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family: "Segoe UI", Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
}

header{
  background:var(--card);
  padding:20px 24px;
  border-bottom:1px solid var(--border);
}

header h1{
  margin:0;
  font-size:22px;
  font-weight:700;
}

.toolbar{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-top:14px;
  align-items:center;
}

.toolbar .group{
  display:flex;
  gap:6px;
  align-items:center;
  flex-wrap:wrap;
}

label{
  font-size:13px;
  color:var(--muted);
}

input, select{
  padding:8px 10px;
  border:1px solid var(--border);
  border-radius:8px;
  font-size:14px;
  background:#fff;
}

input:focus, select:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 1px rgba(37,99,235,.2);
}

button{
  padding:10px 18px;
  border:none;
  border-radius:10px;
  background:var(--primary);
  color:white;
  font-size:14px;
  cursor:pointer;
}

button:hover{background:var(--primary-dark)}

.note{
  font-size:12px;
  color:var(--muted);
  margin-top:8px;
}

.badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#fff;
  color:var(--muted);
}

.badge strong{color:var(--text)}

.actions-right{
  margin-inline-start:auto;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
}

.btn-gray{ background:var(--gray); }
.btn-gray:hover{ background:#4b5563; }

.btn-danger{ background:var(--danger); }
.btn-danger:hover{ background:#b91c1c; }

.btn-ok{ background:var(--ok); }
.btn-ok:hover{ background:#15803d; }

main{
  padding:24px;
  max-width:1400px;
  margin:auto;
}

.team{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  margin-bottom:14px;
  overflow:hidden;
}

.team-header{
  padding:14px 18px;
  background:linear-gradient(90deg,var(--primary),var(--primary-dark));
  color:white;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
}

.team-header span{
  font-size:16px;
  font-weight:600;
}

.team-header small{
  opacity:.85;
}

.team-body{
  display:none;
  padding:12px;
}

table{
  width:100%;
  border-collapse:collapse;
}

th, td{
  padding:10px;
  border-bottom:1px solid var(--border);
  font-size:14px;
}

th{
  background:#f8fafc;
  color:var(--muted);
  font-weight:600;
}

tr:hover td{
  background:#f1f5f9;
}

td input, td select{
  width:100%;
  padding:7px 8px;
  border-radius:8px;
}

.row-saved td{
  background:rgba(22,163,74,.07);
}


.top-header{
  background:var(--card);
  border-bottom:1px solid var(--border);
  padding:18px 24px;
}

.top-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:16px;
}

.top-row h1{
  margin:0;
  font-size:24px;
  font-weight:700;
}

.last-update{
  font-size:13px;
  color:var(--muted);
  background:#f8fafc;
  padding:6px 12px;
  border-radius:999px;
  border:1px solid var(--border);
}

.last-update strong{
  color:var(--text);
}

.action-row{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  gap:16px;
  margin-top:18px;
  flex-wrap:wrap;
}

.left-actions{
  display:flex;
  gap:14px;
  align-items:flex-end;
  flex-wrap:wrap;
}

.left-actions input{
  min-width:220px;
}

.date-group{
  display:flex;
  align-items:center;
  gap:6px;
}

.date-group label{
  font-size:12px;
}

.right-actions{
  display:flex;
  gap:10px;
  align-items:center;
}

.btn-save{
  background:var(--ok);
}
.btn-save:hover{ background:#15803d }

.btn-export{
  background:var(--primary);
}

.status-pill{
  font-size:13px;
  padding:6px 12px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#fff;
  color:var(--muted);
}

.nav-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  margin-top:18px;
  padding-top:14px;
  border-top:1px dashed var(--border);
}

.nav-left, .nav-right{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

.btn-nav{
  background:#6b7280;
}
.btn-nav:hover{ background:#4b5563 }

.btn-danger{
  background:#dc2626;
}
.btn-danger:hover{ background:#b91c1c }

.btn-logout{
  background:#374151;
}
.btn-logout:hover{ background:#1f2937 }
@media(max-width:900px){
  th:nth-child(2), td:nth-child(2),
  th:nth-child(3), td:nth-child(3){
    display:none;
  }
}
</style>
</head>

<body>

<header class="top-header">

  <!-- ROW 1: TITLE + STATUS -->
  <div class="top-row">
    <h1>××¢×¨×›×ª ×”×©×œ××ª ×©×¢×•×ª</h1>

    {% if state and state.last_modified_by %}
    <div class="last-update">
      ×¢×•×“×›×Ÿ ×œ××—×¨×•× ×” ×¢"×™
      <strong>{{ state.last_modified_by }}</strong>
      <span>({{ state.last_modified_at }})</span>
    </div>
    {% endif %}
  </div>

  <!-- ROW 2: MAIN ACTIONS -->
  <div class="action-row">

    <div class="left-actions">
      <input id="search" placeholder="ğŸ” ×—×™×¤×•×© ×¢×•×‘×“â€¦" onkeyup="filterEmployees()">

      <div class="date-group">
        <label>×ª××¨×™×š ×œ×¢×“×›×•×Ÿ</label>
        <input type="date" id="workDate">
      </div>

      <div class="date-group">
        <label>××“×•×—</label>
        <input type="date" id="reportFrom">
        <span>â€“</span>
        <input type="date" id="reportTo">
      </div>
    </div>

    <div class="right-actions">
      <button class="btn-save" onclick="saveAll()">ğŸ’¾ ×©××•×¨ ×”×›×œ</button>
      <button class="btn-export" onclick="exportExcel()">ğŸ“¤ ×™×™×¦×•× ×œ××§×¡×œ</button>
      <span class="status-pill" id="statusText">××•×›×Ÿ</span>
    </div>

  </div>

  <!-- ROW 3: SYSTEM NAV -->
  <div class="nav-row">

    <div class="nav-left">
      {% if role == "admin" %}
        <button class="btn-nav" onclick="goUsers()">ğŸ‘¥ ××©×ª××©×™×</button>
        <button class="btn-nav" onclick="goAudit()">ğŸ“œ Audit</button>
        <button class="btn-danger" onclick="resetSystem()">â™» ××™×¤×•×¡ ××¢×¨×›×ª</button>
      {% endif %}
    </div>

    <div class="nav-right">
      <button class="btn-logout" onclick="logout()">ğŸšª ×”×ª× ×ª×§×•×ª</button>
    </div>

  </div>

</header>

<main>

{% for team, members in teams.items() %}
<div class="team">
  <div class="team-header" onclick="toggleTeam(this)">
    <span>{{ team }}</span>
    <small>{{ members|length }} ×¢×•×‘×“×™×</small>
  </div>

  <div class="team-body">
    <table>
      <thead>
        <tr>
          <th style="width:28%">×¢×•×‘×“</th>
          <th style="width:18%">××©××¨×ª</th>
          <th style="width:22%">×¡×•×’ ×”×©×œ××”</th>
          <th>××œ×œ ×—×•×¤×©×™</th>
        </tr>
      </thead>
      <tbody>
      {% for e in members %}
        <tr data-name="{{ e.name }}">
          <td><strong>{{ e.name }}</strong></td>

          <td>
            <select class="shift">
              {% for s in shifts %}
              <option value="{{ s }}">{{ s }}</option>
              {% endfor %}
            </select>
          </td>

          <td>
            <select class="action">
              {% for a in actions %}
              <option value="{{ a }}">{{ a }}</option>
              {% endfor %}
            </select>
          </td>

          <td>
            <input class="noteInput" placeholder="××œ×œ ×—×•×¤×©×™â€¦">
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endfor %}

</main>

<script>
/* ---------------- ELEMENTS ---------------- */
const workDate   = document.getElementById("workDate");
const reportFrom = document.getElementById("reportFrom");
const reportTo   = document.getElementById("reportTo");
const statusText = document.getElementById("statusText");
const search     = document.getElementById("search");

/* ---------------- STATE ---------------- */
// drafts[date][employeeName] = { name, shift, action, note }
let drafts = {};
let currentDate = null;

const LS_KEY = "hoursDrafts_v1";

/* ---------------- HELPERS ---------------- */
function setStatus(msg){ statusText.textContent = msg; }

function toggleTeam(header){
  const body = header.nextElementSibling;
  body.style.display = body.style.display === "block" ? "none" : "block";
}
function filterEmployees(){
  const q = search.value.toLowerCase().trim();

  document.querySelectorAll(".team").forEach(team=>{
    const body = team.querySelector(".team-body");
    let foundInTeam = false;

    team.querySelectorAll("tr[data-name]").forEach(tr=>{
      const match = tr.dataset.name.toLowerCase().includes(q);
      tr.style.display = match || !q ? "" : "none";
      if(match) foundInTeam = true;
    });

    // ×¤×•×ª×— ×¦×•×•×ª ×× × ××¦× ×¢×•×‘×“ ×‘×ª×•×›×•
    if(foundInTeam && q){
      body.style.display = "block";
    }

    // ×¡×•×’×¨ ×¦×•×•×ª×™× ×¨×™×§×™× ×¨×§ ×›×©×™×© ×—×™×¤×•×©
    if(!foundInTeam && q){
      body.style.display = "none";
    }
  });

  // ×’×œ×™×œ×” ×œ×¢×•×‘×“ ×”×¨××©×•×Ÿ ×©× ××¦×
  if(q){
    const firstMatch = document.querySelector('tr[data-name]:not([style*="display: none"])');
    if(firstMatch){
      firstMatch.scrollIntoView({ behavior: "smooth", block: "center" });
    }
  }
}

/* ---------------- NAV ---------------- */
function logout(){
  // GET /logout => redirect
  window.location.href = "/logout";
}

function goAudit(){ window.location.href = "/audit"; }
function goUsers(){ window.location.href = "/users"; }

/* ---------------- LOCAL STORAGE ---------------- */
function loadLocal(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    drafts = raw ? JSON.parse(raw) : {};
  }catch(e){
    drafts = {};
  }
}

function saveLocal(){
  localStorage.setItem(LS_KEY, JSON.stringify(drafts));
}

function saveAll(){
  saveLocal();

  fetch("/touch", { method: "POST" })
    .then(() => {
      setStatus("× ×©××¨ âœ”");
     
    });
}

/* ---------------- DRAFT SAVE/LOAD ---------------- */
function saveDraftForRow(tr){
  if(!workDate.value){
    setStatus("×‘×—×¨ ×ª××¨×™×š ×œ×¤× ×™ ×”×–× ×”");
    return;
  }

  const date = workDate.value;
  currentDate = date;

  drafts[date] ||= {};

  drafts[date][tr.dataset.name] = {
    name: tr.dataset.name,
    shift: tr.querySelector(".shift").value,
    action: tr.querySelector(".action").value,
    note: tr.querySelector(".noteInput").value
  };

  saveLocal(); // â† ×§×¨×™×˜×™

  tr.classList.add("row-saved");
  setStatus("×˜×™×•×˜×” × ×©××¨×” âœ”");
}

function loadDateToUI(date){
  document.querySelectorAll("tr[data-name]").forEach(tr=>{
    const d = drafts?.[date]?.[tr.dataset.name];

    tr.querySelector(".shift").value = d?.shift || "";
    tr.querySelector(".action").value = d?.action || "";
    tr.querySelector(".noteInput").value = d?.note || "";

    tr.classList.toggle("row-saved", !!d);
  });
}

function ensureDateSelected(){
  if(!workDate.value){
    alert("×™×© ×œ×‘×—×•×¨ ×ª××¨×™×š ×œ×¢×“×›×•×Ÿ");
    return false;
  }
  return true;
}

/* ---------------- EVENTS ---------------- */
document.querySelectorAll("tr[data-name]").forEach(tr=>{
  tr.querySelector(".shift").addEventListener("change", ()=>saveDraftForRow(tr));
  tr.querySelector(".action").addEventListener("change", ()=>saveDraftForRow(tr));
  tr.querySelector(".noteInput").addEventListener("input", ()=>saveDraftForRow(tr));
});

workDate.addEventListener("change", ()=>{
  const date = workDate.value;
  currentDate = date;
  loadDateToUI(date);
  setStatus("×ª××¨×™×š × ×˜×¢×Ÿ");
});

/* ---------------- RESET (admin) ---------------- */
function resetSystem(){
  if(!confirm("âš ï¸ ×œ××—×•×§ ××ª ×›×œ × ×ª×•× ×™ ×”××¢×¨×›×ª ×•×œ×”×ª×—×™×œ ××—×“×©?")) return;

  fetch("/reset", { method:"POST" })
    .then(() => {
      localStorage.removeItem(LS_KEY); // â† ×–×” ×”×§×¨×™×˜×™
      alert("×”××¢×¨×›×ª ××•×¤×¡×” ×‘×”×¦×œ×—×”");
      location.reload();
    });
}

/* ---------------- EXPORT ---------------- */
function exportExcel(){
  if(!reportFrom.value || !reportTo.value){
    alert("×—×•×‘×” ×œ×‘×—×•×¨ ×˜×•×•×— ×ª××¨×™×›×™× ×œ×“×•×—");
    return;
  }

  saveLocal();

  const entries = [];
  const from = reportFrom.value;
  const to   = reportTo.value;

  for(const [date, byName] of Object.entries(drafts)){
    if(date < from || date > to) continue; // FIX: ×¡×™× ×•×Ÿ ×˜×•×•×—

    for(const d of Object.values(byName)){
      if(!d.shift) continue;              // FIX: ×‘×œ×™ ××©××¨×ª â€“ ×œ× ××™×™×¦××™×
      if(!(d.action || d.note)) continue;

      entries.push({
        date,
        name: d.name.trim(),               // FIX: × ×™×§×•×™ ×©×
        shift: d.shift,
        action: d.action,
        note: d.note
      });
    }
  }

if(entries.length === 0){
  alert("××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•× ×‘×˜×•×•×— ×”×ª××¨×™×›×™× ×©× ×‘×—×¨");
  setStatus("××™×Ÿ × ×ª×•× ×™×");
  return;
}

  fetch("/export", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      report_from: from,
      report_to: to,
      entries
    })
  })
  .then(r=>r.blob())
  .then(b=>{
    const a=document.createElement("a");
    a.href=URL.createObjectURL(b);
    a.download="hours_report.xlsx";
    a.click();
  });
}

/* ---------------- INIT ---------------- */
loadLocal();
setStatus("××•×›×Ÿ");

// ××•×¤×¦×™×•× ×œ×™: ×§×‘×¢ ×ª××¨×™×š ×‘×¨×™×¨×ª ××—×“×œ ×œ×”×™×•×
const today = new Date().toISOString().slice(0,10);
if(!workDate.value){
  workDate.value = today;
}

currentDate = workDate.value;
loadDateToUI(currentDate);
</script>

</body>
</html>