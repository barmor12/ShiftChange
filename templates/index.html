<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<title>××¢×¨×›×ª ×”×©×œ××ª ×©×¢×•×ª</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* ================== THEME VARIABLES ================== */
:root{
  --bg:#0b1220;
  --panel:rgba(255,255,255,.08);
  --border:rgba(255,255,255,.18);
  --text:#f8fafc;
  --muted:#cbd5e1;

  --brand1:#60a5fa;
  --brand2:#a78bfa;

  --danger-bg:rgba(239,68,68,.22);
  --danger-text:#fecaca;

  --shadow:0 12px 35px rgba(0,0,0,.45);
  /* ===== SELECT COLORS ===== */
--select-bg: #374151;
--select-text: #f8fafc;
--select-option-bg: #111827;
--select-option-text: #f8fafc;
--select-option-hover: #1f2937;
}



/* ğŸŒ LIGHT MODE */
html[data-theme="light"]{
  --bg:#f4f6fb;
  --panel:#ffffff;
  --border:#e5e7eb;
  --text:#0f172a;
  --muted:#64748b;

  --brand1:#2563eb;
  --brand2:#4f46e5;

  --danger-bg:#fee2e2;
  --danger-text:#991b1b;

  --shadow:0 10px 25px rgba(0,0,0,.08);
    /* ===== SELECT COLORS ===== */
  --select-bg: #ffffff;
  --select-text: #0f172a;
  --select-option-bg: #ffffff;
  --select-option-text: #0f172a;
  --select-option-hover: #e5e7eb;
}

/* ================== BASE ================== */
*{box-sizing:border-box}
html,body{height:100%}

body{
  margin:0;
  font-family:"Segoe UI",Arial,sans-serif;
  background:
    radial-gradient(900px 500px at 10% 10%, rgba(96,165,250,.15), transparent 55%),
    radial-gradient(800px 500px at 80% 10%, rgba(167,139,250,.12), transparent 60%),
    var(--bg);
  color:var(--text);
}

button,input,select{font:inherit}
a{color:inherit;text-decoration:none}

/* ================== TOPBAR ================== */
.topbar{
  position: sticky;
  top: 0;
  z-index: 20;

  /* âŒ ×‘×œ×™ backdrop-filter */
  background: linear-gradient(
    180deg,
    rgba(11,18,32,0.95),
    rgba(2,6,23,0.95)
  );

  border-bottom: 1px solid var(--border);
}

html[data-theme="light"] .topbar{
  background:linear-gradient(180deg,#ffffff,#f1f5f9);
}

.topbar-inner{
  max-width:1400px;
  margin:0 auto;
  padding:14px 16px;
  display:flex;
  gap:14px;
  align-items:center;
  flex-wrap:wrap;
}

/* ================== BRAND ================== */
.brand{
  display:flex;
  gap:10px;
  align-items:center;
  padding:10px 14px;
  border-radius:18px;
  background:var(--panel);
  border:1px solid var(--border);
  box-shadow:var(--shadow);
}
.logo{
  width:38px;
  height:38px;
  border-radius:12px;
  background:linear-gradient(135deg,var(--brand1),var(--brand2));
}
.brand h1{margin:0;font-size:16px}
.brand p{margin:0;font-size:12px;color:var(--muted)}

.spacer{flex:1}

/* ================== NAV BUTTONS ================== */
.navbtn{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:12px 18px;
  border-radius:999px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.06);
  color:var(--text);
  font-weight:600;
  cursor:pointer;
  transition:.2s ease;
}

.navbtn:hover{
  background:rgba(255,255,255,.14);
  transform:translateY(-1px);
}

.navbtn.active{
  background:linear-gradient(135deg,var(--brand1),var(--brand2));
  color:#0b1220;
  border:none;
  box-shadow:0 10px 25px rgba(96,165,250,.35);
}

.navbtn.danger{
  background:var(--danger-bg);
  color:var(--danger-text);
}

/* ================== LAYOUT ================== */
.shell{max-width:1400px;margin:0 auto;padding:18px 16px 40px}

.panel{
  margin-top:16px;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:22px;
  box-shadow:var(--shadow);
  overflow:hidden;
}

.panel-head{
  padding:16px;
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  border-bottom:1px solid var(--border);
}

/* ================== FORM ================== */
.field{display:grid;gap:6px;min-width:220px}
.field label{font-size:12px;color:var(--muted)}

.input,
.noteInput{
  height:42px;
  padding:0 12px;
  border-radius:14px;
  border:1px solid var(--border);
  background: var(--select-bg);
  color: var(--select-text);
}

select{
  height:42px;
  padding:0 12px;
  border-radius:14px;
  border:1px solid var(--border);
  background:var(--select-bg);
  color:var(--select-text);
}



.actions{
  display:flex;
  gap:10px;
  align-items:center;
  margin-inline-start:auto;
}

/* ================== BUTTONS ================== */
.btn{
  height:42px;
  padding:0 16px;
  border-radius:14px;
  border:none;
  font-weight:700;
  cursor:pointer;
  background:linear-gradient(135deg,var(--brand1),var(--brand2));
  color:#0b1220;
}

.btn.ok{
  background:linear-gradient(135deg,#34d399,#22c55e);
}

.status{
  display:flex;
  align-items:center;
  gap:8px;
  padding:0 14px;
  height:42px;
  border-radius:999px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.08);
  color:var(--muted);
}

/* ================== TEAMS ================== */
.content{padding:16px}

.team{
  margin-bottom:14px;
  border-radius:18px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.05);
}

.team-btn{
  width:100%;
  padding:16px;
  display:flex;
  justify-content:space-between;
  border:none;
  background:linear-gradient(135deg,rgba(96,165,250,.25),rgba(167,139,250,.22));
  color:var(--text);
  cursor:pointer;
}

.team-body{display:none}
.team.open .team-body{display:block}

/* ================== TABLE ================== */
table{width:100%;border-collapse:collapse}

thead th{
  padding:12px;
  background:rgba(0,0,0,.25);
  color:var(--muted);
}

tbody td{
  padding:12px;
  border-bottom:1px solid var(--border);
}

tbody tr:hover td{
  background:rgba(255,255,255,.06);
}

/* ================== TOAST ================== */
.toast{
  position: fixed;
  bottom: 20px;
  inset-inline: 20px;
  display: flex;
  justify-content: center;

  opacity: 0;
  transform: translateY(20px);
  pointer-events: none;

  transition: opacity .25s ease, transform .25s ease;
}

.toast.show{
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}
.dot{
  width:10px;
  height:10px;
  border-radius:50%;
  background:#94a3b8;
}

.dot.ok{ background:#22c55e; }
.dot.warn{ background:#facc15; }
.dot.bad{ background:#ef4444; }

.toast-content{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:18px;
  padding:14px 18px;
  box-shadow:var(--shadow); 
}

input,
select,
.noteInput {
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
}
select:focus,
select:active {
  outline: none !important;
  box-shadow: none !important;
}

button,
button:focus,
button:active,
button:focus-visible {
  outline: none !important;
  box-shadow: none !important;
}

* {
  -webkit-tap-highlight-color: transparent !important;
}

/* ===== KILL CHROME GLOBAL FOCUS RING ===== */
:focus,
:focus-visible,
html:focus,
body:focus {
  outline: none !important;
  box-shadow: none !important;
}

/* Chrome bug â€“ removes ghost focus circle */
html {
  -webkit-tap-highlight-color: transparent;
}

/* safety */
*::before,
*::after {
  box-shadow: none !important;
}

/* ===== LAST UPDATE PILL (FIXED) ===== */
.last-update{
  display:inline-flex;
  align-items:center;
  gap:8px;

  padding:8px 14px;
  border-radius:999px;

  background:rgba(255,255,255,.08);
  border:1px solid var(--border);

  font-size:13px;
  font-weight:500;
  color:var(--muted);

  white-space:nowrap;
}

.last-update strong{
  color:var(--text);
  font-weight:600;
}

.last-update span{
  opacity:.8;
}

/* ===== PAYROLL STATUS ===== */
.payroll-dot{
  display:inline-block;
  width:12px;
  height:12px;
  border-radius:50%;
  background:#94a3b8; /* ××¤×•×¨ = ×œ× ×˜×•×¤×œ */
}

.payroll-dot.done{
  background:#f59e0b; /* ×›×ª×•× = ×˜×•×¤×œ ×‘×©×›×¨ */
}

.payroll-dot.bad{
  background:#ef4444; /* ××“×•× = ×©×•× ×” ××—×¨×™ ×©×›×¨ */
}
</style>
</head>

<body>

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>××¢×¨×›×ª ×”×©×œ××ª ×©×¢×•×ª</h1>
          <p>×××©×§ × ×™×”×•×œ ××¨×’×•× ×™</p>
        </div>
      </div>

      {% if state and state.last_modified_by %}
        <div class="last-update" id="lastUpdate">
          <div
            class="last-update"
            id="payrollWarning"
            style="display:none; cursor:pointer; background:var(--danger-bg); color:var(--danger-text)"
            onclick="showDirtyOnly()"
          >
            âš  ×§×™×™××™× <strong id="dirtyCount">0</strong> ×¢×•×‘×“×™× ×©×©×•× ×• ×œ××—×¨ ×“×™×•×•×— ×œ×©×›×¨
          </div>
          ×¢×•×“×›×Ÿ ×œ××—×¨×•× ×” ×¢"×™ <strong>{{ state.last_modified_by }}</strong>
          <span>({{ state.last_modified_at }})</span>
        </div>
      {% endif %}

      <div class="spacer"></div>

      {% if role == "admin" %}
      <button class="navbtn" id="themeBtn" onclick="toggleTheme()">ğŸŒ™</button>
        <button class="navbtn" onclick="goUsers()">ğŸ‘¥ ××©×ª××©×™×</button>
        <button class="navbtn" onclick="goAudit()">ğŸ“œ Audit</button>
        {% if user == config.super_admin %}
          <button class="navbtn danger" onclick="resetSystem()">â™» ××™×¤×•×¡</button>
        {% endif %}
          <label class="btn" style="cursor:pointer">
            ğŸ“¥ ×”×¢×œ××ª ××§×¡×œ ×©×›×¨
            <input
              type="file"
              accept=".xlsx"
              hidden
              onchange="uploadPayrollExcel(this.files[0])"
            />
          </label>
      {% endif %}

      <button class="navbtn" onclick="logout()">ğŸšª ×”×ª× ×ª×§×•×ª</button>
    </div>
  </div>

  <div class="shell">

    <!-- Controls Panel -->
    <div class="panel">
      <div class="panel-head">
        <div class="field" style="min-width:260px;">
          <label>×—×™×¤×•×© ×¢×•×‘×“</label>
          <input id="search" class="input" placeholder="ğŸ” ×›×ª×•×‘ ×©× ×¢×•×‘×“â€¦" onkeyup="filterEmployees()" />
        </div>

        <div class="field">
          <label>×ª××¨×™×š ×œ×¢×“×›×•×Ÿ</label>
          <input type="date" id="workDate" class="input" />
        </div>

        <div class="field" style="min-width:320px;">
          <label>×˜×•×•×— ×“×•×—</label>
          <div style="display:flex; gap:8px; align-items:center;">
            <input type="date" id="reportFrom" class="input" style="flex:1;" />
            <span style="color:var(--muted);">â€“</span>
            <input type="date" id="reportTo" class="input" style="flex:1;" />
          </div>
        </div>

        <div class="actions">
          <button class="btn ok" onclick="saveAll()">ğŸ’¾ ×©××•×¨ ×”×›×œ</button>
          <button class="btn" onclick="exportExcel()">ğŸ“¤ ×™×™×¦×•× ×œ××§×¡×œ</button>
          <div class="status" id="statusText">
            <span class="dot" id="statusDot"></span>
            <span id="statusMsg">××•×›×Ÿ</span>
          </div>
        </div>
      </div>

      <div class="content">
        {% for team, members in teams.items() %}
          <div class="team">
            <button class="team-btn"  type="button">
              <div class="team-title">
                <strong>{{ team }}</strong>
                <span>{{ members|length }} ×¢×•×‘×“×™×</span>
              </div>
              <div class="chev">âŒ„</div>
            </button>

            <div class="team-body">
              <table>
                <thead>
                  <tr>
                    <th style="width:28%">×¢×•×‘×“</th>
                    <th style="width:12%">×¡×˜×˜×•×¡</th> <!-- âœ… ×—×“×© -->
                    <th style="width:14%">××©××¨×ª ××§×•×¨</th>
                    <th style="width:18%">××©××¨×ª</th>
                    <th style="width:22%">×¡×•×’ ×”×©×œ××”</th>
                    
                    <th>×—×¨×™×’×™×</th>
                  </tr>
                </thead>
                <tbody>
                  {% for e in members %}
                    <tr data-name="{{ e.name }}">
                      <td data-label="×¢×•×‘×“">
                        <span class="cell-strong">{{ e.name }}</span>
                      </td>

                      <!-- âœ… ×—×™×•×•×™ ×©×›×¨ -->
                      <td data-label="×©×›×¨">
                        <span class="payroll-dot" title="×œ× ×“×•×•×— ×œ×©×›×¨"></span>
                      </td>
                      <td data-label="××©××¨×ª ××§×•×¨">
                      <select class="select originShift">
                        <option value="">â€”</option>
                        <option value="×‘×•×§×¨">×‘×•×§×¨</option>
                        <option value="×¢×¨×‘">×¢×¨×‘</option>
                        <option value="×œ×™×œ×”">×œ×™×œ×”</option>
                      </select>
                    </td>
                      <td data-label="××©××¨×ª">
                        <select class="select shift">
                          {% for s in shifts %}
                            <option value="{{ s }}">{{ s }}</option>
                          {% endfor %}
                        </select>
                      </td>

                      <td data-label="×¡×•×’ ×”×©×œ××”">
                        <select class="select action">
                          {% for a in actions %}
                            <option value="{{ a }}">{{ a }}</option>
                          {% endfor %}
                        </select>
                      </td>

                      <td data-label="×¡×™×‘×”">
                        <select class="select reason">
                          <option value="">â€” ×‘×—×¨ ×¡×™×‘×” â€”</option>
                          <option value="××•× ×™×” ×‘×™×˜×—×•× ×™×ª">××•× ×™×” ×‘×™×˜×—×•× ×™×ª</option>
                          <option value="×¦×¨×›×™ ××¢×¨×›×ª">×¦×¨×›×™ ××¢×¨×›×ª</option>
                          <option value="×‘×™×˜×•×œ ××©××¨×ª ×”×©×œ××” ×œ×ª×§×Ÿ">×‘×™×˜×•×œ ××©××¨×ª ×”×©×œ××” ×œ×ª×§×Ÿ</option>
                        </select>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

<div class="toast" id="toast">
  <div class="toast-content">
    <strong id="toastTitle"></strong>
    <div id="toastText"></div>
  </div>
</div>
<script>
/* ================== ELEMENTS ================== */
const workDate   = document.getElementById("workDate");
const reportFrom = document.getElementById("reportFrom");
const reportTo   = document.getElementById("reportTo");
const search     = document.getElementById("search");

const statusDot  = document.getElementById("statusDot");
const statusMsg  = document.getElementById("statusMsg");

const toastEl    = document.getElementById("toast");
const toastTitle = document.getElementById("toastTitle");
const toastText  = document.getElementById("toastText");

/* ================== STATE ================== */
const LS_KEY = "hoursDrafts_v4";
let drafts = {};
let currentDate = null;
let payrollStatus = {};
let payrollDirty = {};

/* ================== HELPERS ================== */
function setStatus(msg, type="idle"){
  statusMsg.textContent = msg;
  statusDot.className = "dot";
  if(type==="ok") statusDot.classList.add("ok");
  if(type==="warn") statusDot.classList.add("warn");
  if(type==="bad") statusDot.classList.add("bad");
}

function loadPayrollStatus(){
  fetch("/payroll-status")
    .then(r => r.json())
    .then(data => {
      payrollStatus = data || {};
      refreshPayrollDots();
    });
}
function refreshDirtyWarning(){
  if(!currentDate) return;

  const box = document.getElementById("payrollWarning");
  const num = document.getElementById("dirtyCount");
  if(!box || !num) return;

  // ×¡×˜ ×©×œ ×©××•×ª ×¢×•×‘×“×™× ×¢× ×©×™× ×•×™ ×‘×ª××¨×™×š ×”× ×‘×—×¨
  const names = new Set();

  Object.keys(payrollDirty).forEach(key=>{
    const [date, name] = key.split("|");
    if(date === currentDate){
      names.add(name);
    }
  });

  if(names.size > 0){
    num.textContent = names.size;
    box.style.display = "inline-flex";
  }else{
    box.style.display = "none";
  }
}
let dirtyFilterActive = false;

function showDirtyOnly(){
  dirtyFilterActive = !dirtyFilterActive;

  document.querySelectorAll(".team").forEach(team=>{
    let teamHasDirty = false;

    team.querySelectorAll("tr[data-name]").forEach(tr=>{
      if(!dirtyFilterActive){
        tr.style.display = "";
        return;
      }

      const name = tr.dataset.name;
      const key = `${currentDate}|${name}`;
      const isDirty = !!payrollDirty[key];

      tr.style.display = isDirty ? "" : "none";

      if(isDirty){
        teamHasDirty = true;
      }
    });

    team.classList.toggle("open", dirtyFilterActive && teamHasDirty);
  });
}
function loadPayrollDirty(){
  fetch("/payroll-dirty")
    .then(r=>r.json())
    .then(data=>{
      payrollDirty = data || {};
      refreshDirtyWarning();
      refreshPayrollDots();
    });
}
function refreshPayrollDots(){
  if(!currentDate) return;

  document.querySelectorAll("tr[data-name]").forEach(tr=>{
    const name = tr.dataset.name;
    const dot = tr.querySelector(".payroll-dot");
    if(!dot) return;

    // ğŸ”¥ × ×™×§×•×™ ××•×—×œ×˜ â€“ ×§×¨×™×˜×™
  dot.classList.remove("done", "bad");

  const key = `${currentDate}|${name}`;

  const done  = !!payrollStatus?.[key]?.done;
  const dirty = !!payrollDirty?.[key];

  if(dirty){
    dot.classList.add("bad");
    dot.title = "×©×•× ×” ×œ××—×¨ ×“×™×•×•×— ×œ×©×›×¨";
  }else if(done){
    dot.classList.add("done");
    dot.title = "×“×•×•×— ×œ×©×›×¨";
  }else{
    dot.title = "×˜×¨× ×“×•×•×— ×œ×©×›×¨";
  }
  });
}


function showToast(title, text){
  if(!toastEl) return;

  if(toastTitle) toastTitle.textContent = title;
  if(toastText)  toastText.textContent  = text;

  toastEl.classList.add("show");
  clearTimeout(window.__t);
  window.__t = setTimeout(
    ()=>toastEl.classList.remove("show"),
    2500
  );
}

/* ================== STORAGE ================== */
function loadLocal(){
  try{
    drafts = JSON.parse(localStorage.getItem(LS_KEY)) || {};
  }catch{
    drafts = {};
  }
}

function saveLocalImmediate(){
  localStorage.setItem(LS_KEY, JSON.stringify(drafts));
}
function uploadPayrollExcel(file){
  if(!file) return;

  const fd = new FormData();
  fd.append("file", file);

  fetch("/upload-payroll", {
    method: "POST",
    body: fd
  })
  .then(r => {
    if(!r.ok) throw new Error();
    return r.json();
  })
  .then(() => {
    return Promise.all([
      fetch("/payroll-status").then(r=>r.json()),
      fetch("/payroll-dirty").then(r=>r.json())
    ]);
  })
  .then(([status, dirty])=>{
    payrollStatus = status || {};
    payrollDirty  = dirty  || {};

    refreshPayrollDots();
    refreshDirtyWarning();
    showToast("×”×¦×œ×—×”", "××§×¡×œ ×”×©×›×¨ × ×˜×¢×Ÿ");
  })
  .catch(()=>{
    showToast("×©×’×™××”", "×˜×¢×™× ×ª ×”××§×¡×œ × ×›×©×œ×”");
  });
}
/* ================== DRAFT ================== */
function saveDraftForRow(tr){
  if(!workDate.value){
    setStatus("×‘×—×¨ ×ª××¨×™×š", "warn");
    return;
  }

  const date = workDate.value;
  currentDate = date;

  drafts[date] ||= {};

  drafts[date][tr.dataset.name] = {
    date,
    name: tr.dataset.name,
    originShift: tr.querySelector(".originShift").value,
    shift: tr.querySelector(".shift").value,
    action: tr.querySelector(".action").value,
    reason: tr.querySelector(".reason").value
  };

  saveLocalImmediate();
  tr.classList.add("row-saved");
  setStatus("×˜×™×•×˜×” × ×©××¨×”", "ok");

// ğŸ”„ ×©×™× ×•×™ ××§×•××™ â†’ ×‘×•×“×§×™× ×¢× ×”×©×¨×ª
if (payrollStatus?.[`${currentDate}|${tr.dataset.name}`]?.done) {
  fetch("/payroll-dirty")
    .then(r => r.json())
    .then(dirty => {
      payrollDirty = dirty || {};
      refreshPayrollDots();
      refreshDirtyWarning();
    });
}
}

/* ================== EVENTS ================== */
document.body.addEventListener("change", e=>{
  if(!e.target.matches(".shift,.action,.originShift,.reason")) return;
  const tr = e.target.closest("tr[data-name]");
  if(tr) saveDraftForRow(tr);
});

document.body.addEventListener("input", e=>{
  if(!e.target.classList.contains("noteInput")) return;
  const tr = e.target.closest("tr[data-name]");
  if(tr) saveDraftForRow(tr);
});

/* ================== ACCORDION ================== */
document.body.addEventListener("click", e=>{
  const btn = e.target.closest(".team-btn");
  if(!btn) return;
  btn.closest(".team").classList.toggle("open");
});

/* ================== LOAD DATE ================== */
function loadDateToUI(date){
  document.querySelectorAll("tr[data-name]").forEach(tr=>{
    const d = drafts?.[date]?.[tr.dataset.name];
    tr.querySelector(".originShift").value = d?.originShift || ""; // âœ…
    tr.querySelector(".shift").value = d?.shift || "";
    tr.querySelector(".action").value = d?.action || "";
    tr.querySelector(".reason").value = d?.reason || "";
    tr.classList.toggle("row-saved", !!d);
  });
  refreshPayrollDots();
}

workDate.addEventListener("change", ()=>{
  dirtyFilterActive = false;
  currentDate = workDate.value;

  // ğŸ”¥ ×—×©×•×‘: ×‘×™×˜×•×œ ×¡×™× ×•×Ÿ ×•×—×©×™×¤×” ×©×œ ×”×›×œ
  document.querySelectorAll("tr[data-name]").forEach(tr=>{
    tr.style.display = "";
  });

  loadDateToUI(currentDate);

  fetch("/payroll-dirty")
    .then(r => r.json())
    .then(dirty => {
      payrollDirty = dirty || {};
      refreshPayrollDots();
      refreshDirtyWarning();
    });
});

/* ================== SEARCH ================== */
function filterEmployees(){
  const q = search.value.toLowerCase().trim();
  document.querySelectorAll(".team").forEach(team=>{
    let found=false;
    team.querySelectorAll("tr[data-name]").forEach(tr=>{
      const ok = tr.dataset.name.toLowerCase().includes(q);
      tr.style.display = (!q || ok) ? "" : "none";
      if(ok) found=true;
    });
    team.classList.toggle("open", q && found);
  });
}

/* ================== SAVE ALL ================== */
function saveAll(){
  saveLocalImmediate();

  const entries = [];

  const byName = drafts[currentDate] || {};
  for (const d of Object.values(byName)) {
    if (d.shift && (d.action || d.reason)) {
      entries.push({
        date: d.date,
        name: d.name,
        shift: d.shift,
        action: d.action,
        note: d.reason || ""
      });
    }
  }

  fetch("/touch", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ entries })
  })
  .then(r => {
    if(!r.ok) throw new Error("touch failed");
    return r.json();
  })
  .then(state => {
    setStatus("× ×©××¨", "ok");
    showToast("× ×©××¨", "×›×œ ×”× ×ª×•× ×™× × ×©××¨×•");
    currentDate = workDate.value;

    Promise.all([
      fetch("/payroll-status").then(r=>r.json()),
      fetch("/payroll-dirty").then(r=>r.json())
    ]).then(([status, dirty])=>{
      payrollStatus = status || {};
      payrollDirty  = dirty  || {};

      refreshPayrollDots();
      refreshDirtyWarning();
    });

    const el = document.getElementById("lastUpdate");
    if(el){
      el.innerHTML = `
        ×¢×•×“×›×Ÿ ×œ××—×¨×•× ×” ×¢"×™ <strong>${state.last_modified_by}</strong>
        <span>(${state.last_modified_at})</span>
      `;
    }
  })
  .catch(() => {
    setStatus("×©×’×™××”", "bad");
    showToast("×©×’×™××”", "×”×¢×“×›×•×Ÿ × ×›×©×œ");
  });
}
/* ================== EXPORT ================== */
function exportExcel(){
  if(!reportFrom.value || !reportTo.value){
    showToast("×©×’×™××”", "×‘×—×¨ ×˜×•×•×— ×ª××¨×™×›×™×");
    return;
  }

  saveLocalImmediate(); // ğŸ”¥ ×§×¨×™×˜×™

  const rows = [];

  for(const [date, byName] of Object.entries(drafts)){
    if(date < reportFrom.value || date > reportTo.value) continue;

    for(const d of Object.values(byName)){
      if(d.shift && (d.action || d.reason)){
        rows.push({
          date: d.date,
          name: d.name,
          shift: d.shift,
          action: d.action,
          note: d.reason || ""
        });
      }
    }
  }

  if(!rows.length){
    showToast("××™×Ÿ × ×ª×•× ×™×", "×œ× × ××¦××• ×¨×©×•××•×ª ×œ×™×™×¦×•×");
    return;
  }

  fetch("/export",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      report_from: reportFrom.value,
      report_to: reportTo.value,
      entries: rows
    })
  })
  .then(r=>r.blob())
  .then(b=>{
    const a=document.createElement("a");
    a.href=URL.createObjectURL(b);
    a.download="hours_report.xlsx";
    a.click();
    showToast("×”×¦×œ×—×”", "×”×§×•×‘×¥ ×™×¨×“");
  });
}

/* ================== RESET ================== */
function resetSystem(){
  if(!confirm("×œ××¤×¡ ××ª ×›×œ ×”× ×ª×•× ×™×?")) return;
  fetch("/reset",{method:"POST"}).then(()=>{
    localStorage.removeItem(LS_KEY);
    location.reload();
  });
}

/* ================== NAV ================== */
function logout(){ location.href="/logout"; }
function goUsers(){ location.href="/users"; }
function goAudit(){ location.href="/audit"; }

/* ================== INIT ================== */
loadLocal();
const today = new Date().toISOString().slice(0,10);
workDate.value ||= today;
currentDate = workDate.value;
loadDateToUI(currentDate);
setStatus("××•×›×Ÿ","ok");
Promise.all([
  fetch("/payroll-status").then(r=>r.json()),
  fetch("/payroll-dirty").then(r=>r.json())
]).then(([status, dirty])=>{
  payrollStatus = status || {};
  payrollDirty  = dirty  || {};

  refreshPayrollDots();
  refreshDirtyWarning();
});
/* ================== THEME ================== */
const THEME_KEY = "ui_theme";

function applyTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem(THEME_KEY, theme);

  const btn = document.getElementById("themeBtn");
  if(btn){
    btn.textContent = theme === "dark" ? "ğŸŒ™" : "â˜€ï¸";
  }
}

function toggleTheme(){
  const current =
    document.documentElement.getAttribute("data-theme") || "dark";
  applyTheme(current === "dark" ? "light" : "dark");
}

/* INIT THEME */
(function(){
  const saved = localStorage.getItem(THEME_KEY) || "dark";
  applyTheme(saved);
})();


</script>
</body>
</html>